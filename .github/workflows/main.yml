name: CI/CD Pipeline

on:
  push:
  workflow_dispatch:

jobs:
  pipeline:
    name: Consolidated Pipeline
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Gitleaks Secret Scanner
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Hadolint Dockerfile Linter
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: Dockerfile
          failure-threshold: error

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y radare2 yara libyara-dev binutils binwalk

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install bandit[toml] safety

      - name: Run Bandit security scan
        run: bandit -r reversecore_mcp/ -f txt

      - name: Run Safety check
        run: safety check

      - name: Create test workspace
        run: |
          mkdir -p tests/fixtures/workspace
          mkdir -p tests/fixtures/rules
          echo -n "Hello World" > tests/fixtures/workspace/test_binary.bin

      - name: Run tests
        env:
          REVERSECORE_WORKSPACE: ${{ github.workspace }}/tests/fixtures/workspace
          REVERSECORE_READ_DIRS: ${{ github.workspace }}/tests/fixtures/rules
          LOG_LEVEL: INFO
        run: |
          pytest tests/ -v --cov=reversecore_mcp --cov-report=xml --cov-report=term --cov-fail-under=50

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

      - name: Docker Build and Push
        if: github.ref == 'refs/heads/main'
        env:
          REGISTRY: ghcr.io
        run: |
          RAW_IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME=ghcr.io/$RAW_IMAGE_NAME" >> $GITHUB_ENV

          docker buildx create --use
          docker login -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }} ${{ env.REGISTRY }}

          docker buildx build \
            --context . \
            --file ./Dockerfile \
            --platform linux/amd64,linux/arm64 \
            --push \
            --tag ghcr.io/$RAW_IMAGE_NAME:latest \
            --tag ghcr.io/$RAW_IMAGE_NAME:sha-${{ github.sha }} \
            --cache-from type=gha \
            --cache-to type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        if: github.ref == 'refs/heads/main'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
